{% extends "base.html" %}
{% block title %}Report Builder{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6" x-data="reportBuilder()">
    <div class="flex items-center gap-2 mb-6">
        <a href="/analytics" class="btn btn-ghost btn-sm">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
            </svg>
        </a>
        <h1 class="text-2xl font-bold">Custom Report Builder</h1>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Configuration Panel -->
        <div class="lg:col-span-1">
            <div class="card bg-base-100 shadow">
                <div class="card-body">
                    <h2 class="card-title">Report Configuration</h2>

                    <!-- Entity Selection -->
                    <div class="form-control mb-4">
                        <label class="label">
                            <span class="label-text">Data Source</span>
                        </label>
                        <select class="select select-bordered" x-model="entity" @change="loadFields()">
                            <option value="">Select...</option>
                            {% for e in entities %}
                            <option value="{{ e.key }}">{{ e.label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Field Selection -->
                    <div class="form-control mb-4" x-show="availableFields.length > 0" x-cloak>
                        <label class="label">
                            <span class="label-text">Fields to Include</span>
                        </label>
                        <template x-for="field in availableFields" :key="field">
                            <label class="label cursor-pointer justify-start gap-2 py-1">
                                <input type="checkbox" class="checkbox checkbox-sm"
                                       :value="field" x-model="selectedFields">
                                <span class="label-text" x-text="field.replace(/_/g, ' ')"></span>
                            </label>
                        </template>
                    </div>

                    <!-- Filters -->
                    <div class="form-control mb-4" x-show="entity" x-cloak>
                        <label class="label">
                            <span class="label-text">Status Filter</span>
                        </label>
                        <select class="select select-bordered select-sm" x-model="filterStatus">
                            <option value="">All statuses</option>
                            <option value="active">Active only</option>
                            <option value="inactive">Inactive only</option>
                        </select>
                    </div>

                    <!-- Limit -->
                    <div class="form-control mb-4">
                        <label class="label">
                            <span class="label-text">Max Records</span>
                        </label>
                        <input type="number" class="input input-bordered" x-model="limit" min="1" max="10000">
                    </div>

                    <!-- Generate Button -->
                    <button class="btn btn-primary" @click="generateReport()" :disabled="!entity || loading">
                        <span x-show="loading" class="loading loading-spinner loading-sm"></span>
                        <span x-show="!loading">Generate Report</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="lg:col-span-2">
            <div class="card bg-base-100 shadow">
                <div class="card-body">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="card-title">
                            Results
                            <span x-show="reportData" class="badge badge-primary" x-text="reportData?.count + ' records'" x-cloak></span>
                        </h2>
                        <div class="flex gap-2" x-show="reportData" x-cloak>
                            <button class="btn btn-sm btn-outline" @click="exportCSV()">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                                </svg>
                                CSV
                            </button>
                            <button class="btn btn-sm btn-outline" @click="exportExcel()">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                                </svg>
                                Excel
                            </button>
                        </div>
                    </div>

                    <!-- Error Message -->
                    <div x-show="errorMessage" class="alert alert-error mb-4" x-cloak>
                        <span x-text="errorMessage"></span>
                    </div>

                    <!-- Results Table -->
                    <div class="overflow-x-auto" x-show="reportData" x-cloak>
                        <table class="table table-zebra table-sm">
                            <thead>
                                <tr>
                                    <template x-for="field in reportData?.fields" :key="field">
                                        <th x-text="field.replace(/_/g, ' ')"></th>
                                    </template>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(row, idx) in reportData?.data.slice(0, 50)" :key="idx">
                                    <tr>
                                        <template x-for="field in reportData?.fields" :key="field">
                                            <td x-text="row[field]"></td>
                                        </template>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                        <p x-show="reportData?.count > 50" class="text-sm text-gray-500 mt-2">
                            Showing first 50 of <span x-text="reportData?.count"></span> records. Export to see all.
                        </p>
                    </div>

                    <!-- Empty State -->
                    <div x-show="!reportData && !loading && !errorMessage" class="text-center py-12 text-gray-500">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mx-auto mb-4 opacity-50">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                        </svg>
                        <p>Configure your report and click "Generate Report"</p>
                    </div>

                    <!-- Loading State -->
                    <div x-show="loading" class="text-center py-12" x-cloak>
                        <span class="loading loading-spinner loading-lg"></span>
                        <p class="mt-4 text-gray-500">Generating report...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function reportBuilder() {
    const entitiesData = {{ entities | tojson }};

    return {
        entity: '',
        availableFields: [],
        selectedFields: [],
        filterStatus: '',
        limit: 1000,
        loading: false,
        reportData: null,
        errorMessage: '',

        loadFields() {
            const entity = entitiesData.find(e => e.key === this.entity);
            this.availableFields = entity?.fields || [];
            this.selectedFields = [...this.availableFields];
            this.reportData = null;
            this.errorMessage = '';
        },

        async generateReport() {
            this.loading = true;
            this.errorMessage = '';
            this.reportData = null;

            try {
                const filters = {};
                if (this.filterStatus) {
                    filters.status = { eq: this.filterStatus };
                }

                const response = await fetch('/analytics/api/build', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        entity: this.entity,
                        fields: this.selectedFields,
                        filters: filters,
                        limit: parseInt(this.limit) || 1000,
                    })
                });

                const data = await response.json();

                if (data.error) {
                    this.errorMessage = data.error;
                } else {
                    this.reportData = data;
                }
            } catch (error) {
                console.error('Report generation failed:', error);
                this.errorMessage = 'Failed to generate report. Please try again.';
            } finally {
                this.loading = false;
            }
        },

        exportCSV() {
            const params = new URLSearchParams({
                entity: this.entity,
                fields: this.selectedFields.join(','),
            });
            window.location.href = `/analytics/export/csv?${params}`;
        },

        exportExcel() {
            const params = new URLSearchParams({
                entity: this.entity,
                fields: this.selectedFields.join(','),
            });
            window.location.href = `/analytics/export/excel?${params}`;
        }
    }
}
</script>
{% endblock %}
