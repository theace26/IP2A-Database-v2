{% extends "base.html" %}

{% block title %}Application #{{ application.id }} - Benevolence - IP2A{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Breadcrumb -->
    <div class="text-sm breadcrumbs">
        <ul>
            <li><a href="/dashboard">Dashboard</a></li>
            <li><a href="/operations">Operations</a></li>
            <li><a href="/operations/benevolence">Benevolence</a></li>
            <li>Application #{{ application.id }}</li>
        </ul>
    </div>

    <!-- Page Header -->
    <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4">
        <div>
            <div class="flex items-center gap-3">
                <h1 class="text-2xl font-bold">Benevolence Application #{{ application.id }}</h1>
                <span class="badge {{ get_status_badge_class(application.status) }} badge-lg">
                    {{ application.status.value.replace('_', ' ') | title }}
                </span>
            </div>
            <p class="text-base-content/60 mt-1">
                {{ application.application_date.strftime('%B %d, %Y') if application.application_date else 'Date unknown' }}
            </p>
        </div>
        <div class="flex gap-2">
            <a href="/operations/benevolence" class="btn btn-ghost">Back to List</a>
            {% if application.status.value in ['submitted', 'under_review'] %}
            <button class="btn btn-success">Approve</button>
            <button class="btn btn-error btn-outline">Deny</button>
            {% endif %}
        </div>
    </div>

    <!-- Status Workflow -->
    <div class="card bg-base-100 shadow">
        <div class="card-body">
            <h2 class="card-title text-lg">Application Status</h2>
            <ul class="steps steps-horizontal w-full mt-4">
                <li class="step step-primary" data-content="1">Draft</li>
                <li class="step {{ 'step-primary' if application.status.value in ['submitted', 'under_review', 'approved', 'denied', 'paid'] else '' }}" data-content="2">Submitted</li>
                <li class="step {{ 'step-primary' if application.status.value in ['under_review', 'approved', 'denied', 'paid'] else '' }}" data-content="3">Review</li>
                <li class="step {{ 'step-success' if application.status.value in ['approved', 'paid'] else ('step-error' if application.status.value == 'denied' else '') }}" data-content="{{ '✓' if application.status.value in ['approved', 'paid'] else ('✗' if application.status.value == 'denied' else '4') }}">Decision</li>
                <li class="step {{ 'step-success' if application.status.value == 'paid' else '' }}" data-content="{{ '✓' if application.status.value == 'paid' else '5' }}">Paid</li>
            </ul>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Application Details -->
            <div class="card bg-base-100 shadow">
                <div class="card-body">
                    <h2 class="card-title">Application Details</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div>
                            <label class="text-sm text-base-content/60">Reason</label>
                            <p>
                                <span class="badge {{ get_reason_badge_class(application.reason) }}">
                                    {{ application.reason.value.replace('_', ' ') | title }}
                                </span>
                            </p>
                        </div>
                        <div>
                            <label class="text-sm text-base-content/60">Application Date</label>
                            <p>{{ application.application_date.strftime('%B %d, %Y') if application.application_date else '—' }}</p>
                        </div>
                        <div>
                            <label class="text-sm text-base-content/60">Amount Requested</label>
                            <p class="font-bold text-lg">${{ application.amount_requested | default(0) }}</p>
                        </div>
                        <div>
                            <label class="text-sm text-base-content/60">Amount Approved</label>
                            <p class="font-bold text-lg {{ 'text-success' if application.approved_amount else '' }}">
                                {% if application.approved_amount %}
                                ${{ application.approved_amount }}
                                {% else %}
                                <span class="text-base-content/40">Pending</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    <div class="mt-4">
                        <label class="text-sm text-base-content/60">Description</label>
                        <div class="bg-base-200 p-4 rounded-lg mt-1 whitespace-pre-wrap">{{ application.description or 'No description provided' }}</div>
                    </div>

                    {% if application.notes %}
                    <div class="mt-4">
                        <label class="text-sm text-base-content/60">Notes</label>
                        <div class="bg-base-200 p-4 rounded-lg mt-1 whitespace-pre-wrap">{{ application.notes }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Payment Information -->
            {% if application.status.value == 'paid' %}
            <div class="card bg-base-100 shadow">
                <div class="card-body">
                    <h2 class="card-title">Payment Information</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div>
                            <label class="text-sm text-base-content/60">Payment Date</label>
                            <p>{{ application.payment_date.strftime('%B %d, %Y') if application.payment_date else '—' }}</p>
                        </div>
                        <div>
                            <label class="text-sm text-base-content/60">Payment Method</label>
                            <p>{{ application.payment_method or '—' }}</p>
                        </div>
                        <div>
                            <label class="text-sm text-base-content/60">Amount Paid</label>
                            <p class="font-bold text-lg text-success">${{ application.approved_amount }}</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Review History -->
            {% if application.reviews %}
            <div class="card bg-base-100 shadow">
                <div class="card-body">
                    <h2 class="card-title">Review History</h2>

                    <div class="overflow-x-auto mt-4">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Reviewer</th>
                                    <th>Level</th>
                                    <th>Decision</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for review in application.reviews %}
                                <tr>
                                    <td>{{ review.created_at.strftime('%b %d, %Y') if review.created_at else '—' }}</td>
                                    <td>{{ review.reviewer.email if review.reviewer else 'N/A' }}</td>
                                    <td>{{ review.level.value | upper if review.level else '—' }}</td>
                                    <td>
                                        <span class="badge badge-sm {{ 'badge-success' if review.decision and review.decision.value == 'approved' else 'badge-error' if review.decision and review.decision.value == 'denied' else 'badge-warning' }}">
                                            {{ review.decision.value | title if review.decision else '—' }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Applicant Info -->
            <div class="card bg-base-100 shadow">
                <div class="card-body">
                    <h2 class="card-title text-lg">Applicant</h2>
                    {% if application.member %}
                    <div class="flex items-center gap-3 mt-2">
                        <div class="avatar placeholder">
                            <div class="bg-primary text-primary-content rounded-full w-12">
                                <span>{{ application.member.first_name[0] | upper }}{{ application.member.last_name[0] | upper }}</span>
                            </div>
                        </div>
                        <div>
                            <p class="font-medium">{{ application.member.first_name }} {{ application.member.last_name }}</p>
                            {% if application.member.email %}
                            <p class="text-sm text-base-content/60">{{ application.member.email }}</p>
                            {% endif %}
                        </div>
                    </div>
                    <a href="/members/{{ application.member.id }}" class="btn btn-outline btn-sm mt-3">View Profile</a>
                    {% else %}
                    <p class="text-base-content/50">No applicant information</p>
                    {% endif %}
                </div>
            </div>

            <!-- Update Status -->
            <div class="card bg-base-100 shadow">
                <div class="card-body">
                    <h2 class="card-title text-lg">Update Status</h2>
                    <select class="select select-bordered w-full mt-2">
                        {% for status in all_statuses %}
                        <option value="{{ status }}" {{ 'selected' if application.status.value == status }}>
                            {{ status.replace('_', ' ') | title }}
                        </option>
                        {% endfor %}
                    </select>
                    <button class="btn btn-primary btn-sm mt-2">Update</button>
                </div>
            </div>

            <!-- Timeline -->
            <div class="card bg-base-100 shadow">
                <div class="card-body">
                    <h2 class="card-title text-lg">Timeline</h2>
                    <div class="space-y-3 text-sm mt-2">
                        <div class="flex justify-between">
                            <span class="text-base-content/60">Applied</span>
                            <span>{{ application.application_date.strftime('%b %d, %Y') if application.application_date else '—' }}</span>
                        </div>
                        {% if application.payment_date %}
                        <div class="flex justify-between">
                            <span class="text-base-content/60">Paid</span>
                            <span>{{ application.payment_date.strftime('%b %d, %Y') }}</span>
                        </div>
                        {% endif %}
                        <div class="divider my-2"></div>
                        <div class="flex justify-between">
                            <span class="text-base-content/60">Created</span>
                            <span>{{ application.created_at.strftime('%b %d, %Y') if application.created_at else '—' }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-base-content/60">Updated</span>
                            <span>{{ application.updated_at.strftime('%b %d, %Y') if application.updated_at else '—' }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
